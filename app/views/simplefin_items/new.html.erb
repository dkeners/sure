<% content_for :title, "Add SimpleFin Connection" %>

<%= render DS::Dialog.new do |dialog| %>
  <% dialog.with_header(title: "Add SimpleFin Connection") do %>
    <div class="flex items-center gap-2">
      <%= icon "building-2", class: "text-green-600" %>
      <span>Connect your bank account through SimpleFin</span>
    </div>
  <% end %>
  <% dialog.with_body do %>
    <% if @error_message.present? %>
      <%= render DS::Alert.new(message: @error_message, variant: :error) %>
    <% end %>
    <%= form_with(model: @simplefin_item, local: true, data: { turbo: false }, class: "space-y-6") do |form| %>
      <div class="space-y-4">
        <div>
          <%= form.label :setup_token, "SimpleFin Setup Token", class: "block text-sm font-medium text-primary mb-2" %>
          <%= form.text_area :setup_token, 
                placeholder: "Paste your SimpleFin setup token here...",
                rows: 4,
                class: "w-full px-3 py-2 border border-primary rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm font-mono" %>
          <p class="text-xs text-secondary mt-1">
            Get your setup token from 
            <%= link_to "SimpleFin Bridge", "https://bridge.simplefin.org/simplefin/create", 
                target: "_blank", 
                class: "text-blue-600 hover:text-blue-800 underline" %>
          </p>
        </div>

        <div class="bg-blue-50 p-4 rounded-lg">
          <div class="flex items-start gap-3">
            <%= icon "info", size: "sm", class: "text-blue-600 mt-0.5 flex-shrink-0" %>
            <div>
              <h3 class="text-sm font-medium text-blue-900 mb-1">How to get your setup token:</h3>
              <ol class="text-xs text-blue-800 space-y-1 list-decimal list-inside">
                <li>Visit <%= link_to "SimpleFin Bridge", "https://bridge.simplefin.org/simplefin/create", target: "_blank", class: "underline" %></li>
                <li>Connect your bank account using your online banking credentials</li>
                <li>Copy the SimpleFin setup token that appears (it will be a long Base64-encoded string)</li>
                <li>Paste it above and click "Add Connection"</li>
              </ol>
              <p class="text-xs text-blue-700 mt-2">
                <strong>Note:</strong> Setup tokens can only be used once. If the connection fails, you'll need to create a new token.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex gap-3">
        <%= form.submit "Add Connection", 
            class: "flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" %>
        <%= link_to "Cancel", 
            simplefin_items_path, 
            class: "px-4 py-2 text-secondary hover:text-primary" %>
      </div>
    <% end %>
  <% end %>
<% end %>